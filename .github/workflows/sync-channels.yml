# é€šé“åŒæ­¥å·¥ä½œæµç¨‹ / Channel Sync Workflow
# æ­¤å·¥ä½œæµç¨‹è‡ªå‹•åŒæ­¥ä¸»åˆ†æ”¯èˆ‡é–‹ç™¼é€šé“ä¹‹é–“çš„è®Šæ›´
# This workflow automatically syncs changes between master and development channels
# ä½¿ç”¨ç›´é€šåŸç† - ä»»ä½•åˆ†æ”¯çš„è®Šæ›´æœƒè‡ªå‹•åŒæ­¥åˆ°å…¶ä»–é€šé“
# Using direct-through principle - changes to any branch auto-sync to other channels

name: Channel Sync / é€šé“åŒæ­¥

on:
  # è‡ªå‹•è§¸ç™¼ï¼šç•¶ä»»ä½•é€šé“æœ‰æ¨é€æ™‚ / Auto-trigger on push to any channel
  push:
    branches:
      - master
      - main
      - dev
      - release
  # æ‰‹å‹•è§¸ç™¼é¸é … / Manual trigger option
  workflow_dispatch:
    inputs:
      sync_direction:
        description: 'åŒæ­¥æ–¹å‘ / Sync Direction'
        required: true
        default: 'full-sync'
        type: choice
        options:
          - full-sync
          - master-to-dev
          - dev-to-master
          - master-to-release

permissions:
  contents: write
  pull-requests: write

# é˜²æ­¢åŒæ™‚é‹è¡Œå¤šå€‹åŒæ­¥ / Prevent concurrent syncs
concurrency:
  group: channel-sync-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # åˆå§‹åŒ–é€šé“ / Initialize channels
  init-channels:
    name: Initialize Channels / åˆå§‹åŒ–é€šé“
    runs-on: ubuntu-latest
    outputs:
      default_branch: ${{ steps.detect-branch.outputs.default_branch }}
      dev_exists: ${{ steps.check-branches.outputs.dev_exists }}
      release_exists: ${{ steps.check-branches.outputs.release_exists }}
      triggered_by: ${{ steps.detect-trigger.outputs.triggered_by }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Detect Default Branch
        id: detect-branch
        run: |
          DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "master")
          echo "default_branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          echo "Detected default branch: $DEFAULT_BRANCH"

      - name: Check Existing Branches
        id: check-branches
        run: |
          if git ls-remote --exit-code --heads origin dev >/dev/null 2>&1; then
            echo "dev_exists=true" >> $GITHUB_OUTPUT
          else
            echo "dev_exists=false" >> $GITHUB_OUTPUT
          fi
          
          if git ls-remote --exit-code --heads origin release >/dev/null 2>&1; then
            echo "release_exists=true" >> $GITHUB_OUTPUT
          else
            echo "release_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect Trigger Source
        id: detect-trigger
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "triggered_by=manual" >> $GITHUB_OUTPUT
          else
            BRANCH="${{ github.ref_name }}"
            echo "triggered_by=$BRANCH" >> $GITHUB_OUTPUT
          fi

  # ç›´é€šåŒæ­¥ / Direct-through sync
  direct-sync:
    name: Direct-Through Sync / ç›´é€šåŒæ­¥
    runs-on: ubuntu-latest
    needs: init-channels
    # è·³éå¦‚æœæ˜¯ç”±åŒæ­¥æ©Ÿå™¨äººè§¸ç™¼çš„ / Skip if triggered by sync bot
    if: github.actor != 'github-actions[bot]'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Dev Channel (if needed)
        if: needs.init-channels.outputs.dev_exists == 'false'
        run: |
          DEFAULT_BRANCH="${{ needs.init-channels.outputs.default_branch }}"
          echo "ğŸ”§ Creating dev channel from $DEFAULT_BRANCH..."
          git checkout -b dev "origin/$DEFAULT_BRANCH"
          git push -u origin dev
          echo "âœ… Created dev channel"

      - name: Create Release Channel (if needed)
        if: needs.init-channels.outputs.release_exists == 'false'
        run: |
          DEFAULT_BRANCH="${{ needs.init-channels.outputs.default_branch }}"
          echo "ğŸ”§ Creating release channel from $DEFAULT_BRANCH..."
          git checkout -b release "origin/$DEFAULT_BRANCH"
          git push -u origin release
          echo "âœ… Created release channel"

      # ç›´é€šåŒæ­¥ï¼šmaster â†’ dev / Direct-through: master â†’ dev
      - name: Sync Master â†’ Dev (Direct-Through)
        if: |
          (needs.init-channels.outputs.triggered_by == 'master' || 
           needs.init-channels.outputs.triggered_by == 'main' ||
           github.event.inputs.sync_direction == 'full-sync' ||
           github.event.inputs.sync_direction == 'master-to-dev')
        run: |
          DEFAULT_BRANCH="${{ needs.init-channels.outputs.default_branch }}"
          echo "ğŸ”„ ç›´é€šåŒæ­¥ / Direct-through sync: $DEFAULT_BRANCH â†’ dev"
          
          git fetch origin
          
          # æª¢æŸ¥ dev åˆ†æ”¯æ˜¯å¦å­˜åœ¨ / Check if dev branch exists
          if git ls-remote --exit-code --heads origin dev >/dev/null 2>&1; then
            git checkout dev
            git pull origin dev --rebase=false || true
          else
            echo "Creating dev branch from $DEFAULT_BRANCH"
            git checkout -b dev "origin/$DEFAULT_BRANCH"
          fi
          
          # ä½¿ç”¨ fast-forward åˆä½µå¯¦ç¾ç›´é€š / Use fast-forward merge for direct-through
          if git merge "origin/$DEFAULT_BRANCH" --ff-only 2>/dev/null; then
            echo "âœ… Fast-forward merge successful"
            git push origin dev
          elif git merge "origin/$DEFAULT_BRANCH" --no-edit; then
            echo "âœ… Merge successful"
            git push origin dev
          else
            echo "âš ï¸ Merge conflict detected, skipping auto-sync"
            echo "Please resolve conflicts manually or create a PR"
            git merge --abort || true
          fi

      # ç›´é€šåŒæ­¥ï¼šdev â†’ master / Direct-through: dev â†’ master
      - name: Sync Dev â†’ Master (Direct-Through)
        if: |
          needs.init-channels.outputs.triggered_by == 'dev' ||
          github.event.inputs.sync_direction == 'full-sync' ||
          github.event.inputs.sync_direction == 'dev-to-master'
        run: |
          DEFAULT_BRANCH="${{ needs.init-channels.outputs.default_branch }}"
          echo "ğŸ”„ ç›´é€šåŒæ­¥ / Direct-through sync: dev â†’ $DEFAULT_BRANCH"
          
          git fetch origin
          
          # æª¢æŸ¥ dev åˆ†æ”¯æ˜¯å¦å­˜åœ¨ / Check if dev branch exists
          if ! git ls-remote --exit-code --heads origin dev >/dev/null 2>&1; then
            echo "âš ï¸ Dev branch does not exist, skipping sync"
            exit 0
          fi
          
          git checkout "$DEFAULT_BRANCH"
          git pull origin "$DEFAULT_BRANCH" --rebase=false || true
          
          # ä½¿ç”¨ fast-forward åˆä½µå¯¦ç¾ç›´é€š / Use fast-forward merge for direct-through
          if git merge origin/dev --ff-only 2>/dev/null; then
            echo "âœ… Fast-forward merge successful"
            git push origin "$DEFAULT_BRANCH"
          elif git merge origin/dev --no-edit; then
            echo "âœ… Merge successful"
            git push origin "$DEFAULT_BRANCH"
          else
            echo "âš ï¸ Merge conflict detected, skipping auto-sync"
            echo "Please resolve conflicts manually or create a PR"
            git merge --abort || true
          fi

      # ç›´é€šåŒæ­¥ï¼šmaster â†’ release / Direct-through: master â†’ release
      - name: Sync Master â†’ Release (Direct-Through)
        if: |
          (needs.init-channels.outputs.triggered_by == 'master' || 
           needs.init-channels.outputs.triggered_by == 'main' ||
           github.event.inputs.sync_direction == 'full-sync' ||
           github.event.inputs.sync_direction == 'master-to-release')
        run: |
          DEFAULT_BRANCH="${{ needs.init-channels.outputs.default_branch }}"
          echo "ğŸ”„ ç›´é€šåŒæ­¥ / Direct-through sync: $DEFAULT_BRANCH â†’ release"
          
          git fetch origin
          
          # æª¢æŸ¥ release åˆ†æ”¯æ˜¯å¦å­˜åœ¨ / Check if release branch exists
          if git ls-remote --exit-code --heads origin release >/dev/null 2>&1; then
            git checkout release
            git pull origin release --rebase=false || true
          else
            echo "Creating release branch from $DEFAULT_BRANCH"
            git checkout -b release "origin/$DEFAULT_BRANCH"
          fi
          
          # ä½¿ç”¨ fast-forward åˆä½µå¯¦ç¾ç›´é€š / Use fast-forward merge for direct-through
          if git merge "origin/$DEFAULT_BRANCH" --ff-only 2>/dev/null; then
            echo "âœ… Fast-forward merge successful"
            git push origin release
          elif git merge "origin/$DEFAULT_BRANCH" --no-edit; then
            echo "âœ… Merge successful"
            git push origin release
          else
            echo "âš ï¸ Merge conflict detected, skipping auto-sync"
            echo "Please resolve conflicts manually or create a PR"
            git merge --abort || true
          fi

      - name: Sync Summary
        run: |
          echo "## ğŸ”„ ç›´é€šåŒæ­¥æ‘˜è¦ / Direct-Through Sync Summary"
          echo ""
          echo "### è§¸ç™¼ä¾†æº / Triggered By: ${{ needs.init-channels.outputs.triggered_by }}"
          echo ""
          echo "### é€šé“æ¶æ§‹ / Channel Architecture:"
          echo '```'
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚     ç›´é€šåŒæ­¥ç³»çµ± / Direct-Through Sync      â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚                                             â”‚"
          echo "â”‚   master â†â”€â”€ç›´é€šâ”€â”€â†’ dev                    â”‚"
          echo "â”‚     â”‚                                       â”‚"
          echo "â”‚     â””â”€â”€ç›´é€šâ”€â”€â†’ release                     â”‚"
          echo "â”‚                                             â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo '```'
          echo ""
          echo "åŒæ­¥å®Œæˆæ–¼ / Sync completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

  notify-sync:
    name: Notify Sync Status
    runs-on: ubuntu-latest
    needs: [init-channels, direct-sync]
    if: always()
    
    steps:
      - name: Report Sync Status
        run: |
          if [ "${{ needs.direct-sync.result }}" == "success" ]; then
            echo "âœ… ç›´é€šåŒæ­¥æˆåŠŸå®Œæˆ / Direct-through sync completed successfully"
          elif [ "${{ needs.direct-sync.result }}" == "skipped" ]; then
            echo "â­ï¸ åŒæ­¥å·²è·³é (ç”±æ©Ÿå™¨äººè§¸ç™¼) / Sync skipped (triggered by bot)"
          else
            echo "âŒ ç›´é€šåŒæ­¥å¤±æ•— / Direct-through sync failed"
          fi
